#!/usr/bin/env bash

script_name=$(/usr/bin/basename ${0})

function usage {
    /bin/echo "usage: ${script_name} -[dgirsu]"
    /bin/echo "      -d       specify which domain to join"
    /bin/echo "      -g       specify which domain group to require membership of"
    /bin/echo "      -i       Install PBIS"
    /bin/echo "      -r       remove Posix user from system"
    /bin/echo "      -s       indicate that this machine is a server"
    /bin/echo "      -u       specify the user with which to join to the domain"
    exit 1
}

if [ $# == 0 ]; then
    usage
fi

while getopts ":d:g:u:irs" opt; do
    case ${opt} in
        d)
            DOMAIN=${OPTARG}
            ;;
        g)
            DOMAIN_GROUP=${OPTARG}
            ;;
        i)
            INSTALL_PBIS=1
            ;;
        r)
            REMOVE_POSIX_USER=1
            ;;
        s)
            IS_SERVER=1
            ;;
        u)
            DOMAIN_USER=${OPTARG}
            ;;
        \?)
            /bin/echo "Invalid option: -${OPTARG}" >&2
            exit 1
            ;;
        :)
            /bin/echo "Option -${OPTARG} requires an argument." >&2
            exit 1
            ;;
    esac
done

if [ ${INSTALL_PBIS} ]; then
    /bin/echo "*******************************************************************************"
    /bin/echo "**                            Installing PBIS 8.3                            **"
    /bin/echo "*******************************************************************************"
    pushd /tmp
        /usr/bin/wget http://download.beyondtrust.com/PBISO/8.3/pbis-open-8.3.0.3287.linux.x86_64.deb.sh
        /bin/bash -e pbis-open-8.3.0.3287.linux.x86_64.deb.sh
        /bin/rm --recursive --force pbis*
    popd
fi

PBIS_HOME=/opt/pbis
PBIS_CONFIG=${PBIS_HOME}/bin/config

if [ ! -e ${PBIS_HOME}/bin/domainjoin-cli ]; then
    echo "You need to install PBIS first; Re-run with -i to install."
    exit 1
fi

if [ ! ${IS_SERVER} ]; then
    DOMAINJOIN_ARGS="--disable ssh"
else
    DOMAINJOIN_ARGS=
fi

${PBIS_HOME}/bin/domainjoin-cli join ${DOMAINJOIN_ARGS} ${DOMAIN}.loc ${DOMAIN_USER}@${DOMAIN}.loc
if [ ! $? == 0 ]; then
    echo "Joining domain failed!  Exiting..."
fi

/bin/sed --in-place 's/session\toptional\tpam_lsass.so/session\t[success=ok default=ignore]\tpam_lsass.so/' /etc/pam.d/common-session
${PBIS_CONFIG} Requiremembershipof "${DOMAIN}\\${DOMAIN_GROUP}"
${PBIS_CONFIG} HomeDirTemplate "%H/%U"
${PBIS_CONFIG} LoginShellTemplate "/bin/bash"
${PBIS_CONFIG} UserDomainPrefix "${DOMAIN}.loc"
${PBIS_CONFIG} AssumeDefaultDomain true

/bin/cat >> /etc/sudoers.d/${DOMAIN}_domain << EOF
# Afford Linux admins their sudo rights
%${DOMAIN}\\\\${DOMAIN_GROUP} ALL=(ALL:ALL) ALL
EOF

if [ ${REMOVE_POSIX_USER} ]; then
    /bin/echo "*******************************************************************************"
    /bin/echo "**                 Removing user ${DOMAIN_USER} from system!                 **"
    /bin/echo "*******************************************************************************"
    UID=$(/usr/bin/id -u ${DOMAIN_USER})
    /usr/sbin/deluser ${DOMAIN_USER}
    /usr/bin/find /home -uid ${UID} -exec /bin/chown ${DOMAIN}\\${DOMAIN_USER}:${DOMAIN}\\${DOMAIN_GROUP}
fi

if [ ${IS_SERVER} ]; then
    /bin/echo "*******************************************************************************"
    /bin/echo "**                            Server config done                             **"
    /bin/echo "*******************************************************************************"
elif [ ! -z $(/usr/bin/which unity-greeter) ]; then
    /bin/echo "*******************************************************************************"
    /bin/echo "**                        Configuring Login Manager                          **"
    /bin/echo "*******************************************************************************"

    /bin/cat > /usr/share/lightdm/lightdm.conf.d/50-unity-greeter.conf << EOF
[SeatDefaults]
greeter-session=unity-greeter
allow-guest=false
greeter-show-remote-login=false
greeter-show-manual-login=true
EOF
fi
exit 0
